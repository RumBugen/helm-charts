name: Release Charts

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: release
  cancel-in-progress: false

permissions:
  contents: write # GitHub Releases + gh-pages
  packages: write # GHCR (OCI)

env:
  DOCKERHUB_REGISTRY: registry-1.docker.io
  GHCR_REGISTRY: ghcr.io

jobs:
  release:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "$GITHUB_ACTOR"
          git config user.email "$GITHUB_ACTOR@users.noreply.github.com"

      - name: Set up Helm
        uses: azure/setup-helm@v4

      - name: Install cosign
        uses: sigstore/cosign-installer@v3.10.0

      - name: Update chart dependencies
        shell: bash
        run: |
          set -euo pipefail
          for chart_dir in charts/*; do
            if [[ -f "${chart_dir}/Chart.yaml" ]]; then
              helm dependency update "${chart_dir}"
            fi
          done

      - name: Run chart-releaser
        id: cr
        uses: helm/chart-releaser-action@v1.7.0
        with:
          charts_dir: charts
          skip_existing: true
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Login to GHCR (Helm OCI)
        if: steps.cr.outputs.changed_charts != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub (Helm OCI)
        if: steps.cr.outputs.changed_charts != ''
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKERHUB_REGISTRY }}
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push charts to OCI registries and sign (cosign)
        if: steps.cr.outputs.changed_charts != ''
        shell: bash
        env:
          COSIGN_PASSWORD: ${{ secrets.COSIGN_PASSWORD }}
          COSIGN_PRIVATE_KEY: ${{ secrets.COSIGN_PRIVATE_KEY }}
        run: |
          set -euo pipefail

          if [[ -z "${COSIGN_PRIVATE_KEY:-}" ]]; then
            echo "COSIGN_PRIVATE_KEY secret is missing."
            exit 1
          fi
          if [[ -z "${COSIGN_PASSWORD:-}" ]]; then
            echo "COSIGN_PASSWORD secret is missing."
            exit 1
          fi

          printf '%s' "${COSIGN_PRIVATE_KEY}" > cosign.key
          chmod 0600 cosign.key

          owner="${{ github.repository_owner }}"
          owner="${owner,,}"
          dockerhub_username="${{ vars.DOCKERHUB_USERNAME }}"
          dockerhub_username="${dockerhub_username,,}"
          if [[ -z "${dockerhub_username}" ]]; then
            echo "Repository variable DOCKERHUB_USERNAME is empty."
            exit 1
          fi

          echo "Logging in Helm registries..."
          printf '%s' "${{ secrets.GITHUB_TOKEN }}" | helm registry login "${GHCR_REGISTRY}" -u "${GITHUB_ACTOR}" --password-stdin
          printf '%s' "${{ secrets.DOCKERHUB_TOKEN }}" | helm registry login "${DOCKERHUB_REGISTRY}" -u "${dockerhub_username}" --password-stdin

          push_and_sign() {
            local registry="$1"
            local namespace="$2"
            local chart="$3"
            local version="$4"
            local pkg="$5"

            local repo_ref="${registry}/${namespace}/${chart}:${version}"
            local push_out push_status

            set +e
            push_out="$(helm push "${pkg}" "oci://${registry}/${namespace}" 2>&1)"
            push_status=$?
            set -e

            echo "${push_out}"
            if [[ ${push_status} -ne 0 ]]; then
              echo "helm push failed for ${repo_ref}"
              return "${push_status}"
            fi

            local digest
            digest="$(echo "${push_out}" | grep -Eo 'sha256:[a-f0-9]+' | tail -n 1 || true)"
            if [[ -z "${digest}" ]]; then
              echo "Failed to parse digest from helm push output for ${repo_ref}"
              return 1
            fi

            cosign sign -y --key cosign.key "${registry}/${namespace}/${chart}@${digest}"
          }

          changed="${{ steps.cr.outputs.changed_charts }}"
          while IFS= read -r item; do
            item="$(echo "${item}" | xargs)"
            [[ -z "${item}" ]] && continue

            chart="${item##*/}"
            chart="${chart#charts/}"
            chart_dir="charts/${chart}"

            if [[ ! -f "${chart_dir}/Chart.yaml" ]]; then
              echo "Chart directory '${chart_dir}' does not exist or has no Chart.yaml"
              exit 1
            fi

            version="$(awk -F: '$1=="version"{gsub(/^[ \t]+|[ \t]+$/,"",$2); gsub(/"/,"",$2); print $2; exit}' "${chart_dir}/Chart.yaml")"
            pkg=".cr-release-packages/${chart}-${version}.tgz"

            if [[ ! -f "${pkg}" ]]; then
              echo "Package not found: ${pkg}"
              ls -la .cr-release-packages || true
              exit 1
            fi

            push_and_sign "${GHCR_REGISTRY}" "${owner}" "${chart}" "${version}" "${pkg}"
            push_and_sign "${DOCKERHUB_REGISTRY}" "${dockerhub_username}" "${chart}" "${version}" "${pkg}"
          done < <(printf '%s\n' "${changed}" | tr ',' '\n')